#!/usr/bin/env bash

if [ -z $1 ]; then
    flag=""
else
    flag=$1
fi

set -eu

prelude () {
    clippy
    cargo test --bin schedule
    rustfmts
    for x in teams schedule games; do
        if [ "$flag" = "debug" ]; then
            cargo build --bin $x
        else
            cargo build --bin $x --release
        fi
    done
}

interlude () {
    f () {
        export START=$1
        export END=$2
        if [ "$flag" = "debug" ]; then
            cargo run --bin schedule
            cargo run --bin games
        else
            cargo run --bin schedule --release
            cargo run --bin games --release
        fi
    }

    x="$WD/data/teams.json"
    if [ ! -f $x ]; then
        curl "https://statsapi.web.nhl.com/api/v1/teams" > $x
    fi
    if [ "$flag" = "debug" ]; then
        cargo run --bin teams
    else
        cargo run --bin teams --release
    fi
    f "2017-08-01" "2018-08-01"
    f "2018-08-01" "2019-08-01"
}

postlude () {
    f () {
        printf "\nsql $1\n"
        rlwrap sqlite3 --column --header $WD/ruskie.db "$1"
    }

    for x in teams games; do
        f "select count(*) from $x;"
        f "select count(distinct id) from $x;"
    done
}

main () {
    cd $WD/dev
    prelude
    interlude
    postlude
}

main
