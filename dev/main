#!/usr/bin/env bash

set -eu

prelude () {
    clippy
    rustfmts
    cargo test --bin schedule
    for x in teams schedule games; do
        cargo build --bin $x --release
    done
}

interlude () {
    f () {
        export START=$1
        export END=$2
        cargo run --bin schedule --release
        cargo run --bin games --release
    }

    $WD/scripts/curl_teams.sh
    cargo run --bin teams --release
    f "2017-08-01" "2018-08-01"
    f "2018-08-01" "2019-08-01"
}

postlude () {
    f () {
        printf "\nsql $1\n"
        rlwrap sqlite3 --column --header $WD/ruskie.db "$1"
    }

    for x in teams games; do
        f "select count(*) from $x;"
        f "select count(distinct id) from $x;"
    done
}

main () {
    cd $WD/dev
    prelude
    interlude
    postlude
}

main
